{"version":3,"file":"multi-file-upload.mjs","sources":["../../../../src/moj/components/multi-file-upload/multi-file-upload.mjs"],"sourcesContent":["import $ from 'jquery'\n\nimport {\n  dragAndDropSupported,\n  fileApiSupported,\n  formDataSupported\n} from '../../helpers.mjs'\n\nexport function MultiFileUpload(params) {\n  if (!(dragAndDropSupported() && formDataSupported() && fileApiSupported())) {\n    return\n  }\n\n  this.defaultParams = {\n    uploadFileEntryHook: $.noop,\n    uploadFileExitHook: $.noop,\n    uploadFileErrorHook: $.noop,\n    fileDeleteHook: $.noop,\n    uploadStatusText: 'Uploading files, please wait',\n    dropzoneHintText: 'Drag and drop files here or',\n    dropzoneButtonText: 'Choose files'\n  }\n\n  this.params = $.extend({}, this.defaultParams, params)\n  this.container = $(this.params.container)\n\n  this.container.addClass('moj-multi-file-upload--enhanced')\n\n  this.feedbackContainer = this.container.find(\n    '.moj-multi-file__uploaded-files'\n  )\n  this.setupFileInput()\n  this.setupDropzone()\n  this.setupLabel()\n  this.setupStatusBox()\n  this.container.on(\n    'click',\n    '.moj-multi-file-upload__delete',\n    $.proxy(this, 'onFileDeleteClick')\n  )\n}\n\nMultiFileUpload.prototype.setupDropzone = function () {\n  this.fileInput.wrap('<div class=\"moj-multi-file-upload__dropzone\" />')\n  this.dropzone = this.container.find('.moj-multi-file-upload__dropzone')\n  this.dropzone.on('dragover', $.proxy(this, 'onDragOver'))\n  this.dropzone.on('dragleave', $.proxy(this, 'onDragLeave'))\n  this.dropzone.on('drop', $.proxy(this, 'onDrop'))\n}\n\nMultiFileUpload.prototype.setupLabel = function () {\n  this.label = $(\n    `<label for=\"${this.fileInput[0].id}\" class=\"govuk-button govuk-button--secondary\">${this.params.dropzoneButtonText}</label>`\n  )\n  this.dropzone.append(\n    `<p class=\"govuk-body\">${this.params.dropzoneHintText}</p>`\n  )\n  this.dropzone.append(this.label)\n}\n\nMultiFileUpload.prototype.setupFileInput = function () {\n  this.fileInput = this.container.find('.moj-multi-file-upload__input')\n  this.fileInput.on('change', $.proxy(this, 'onFileChange'))\n  this.fileInput.on('focus', $.proxy(this, 'onFileFocus'))\n  this.fileInput.on('blur', $.proxy(this, 'onFileBlur'))\n}\n\nMultiFileUpload.prototype.setupStatusBox = function () {\n  this.status = $(\n    '<div aria-live=\"polite\" role=\"status\" class=\"govuk-visually-hidden\" />'\n  )\n  this.dropzone.append(this.status)\n}\n\nMultiFileUpload.prototype.onDragOver = function (e) {\n  e.preventDefault()\n  this.dropzone.addClass('moj-multi-file-upload--dragover')\n}\n\nMultiFileUpload.prototype.onDragLeave = function () {\n  this.dropzone.removeClass('moj-multi-file-upload--dragover')\n}\n\nMultiFileUpload.prototype.onDrop = function (e) {\n  e.preventDefault()\n  this.dropzone.removeClass('moj-multi-file-upload--dragover')\n  this.feedbackContainer.removeClass('moj-hidden')\n  this.status.html(this.params.uploadStatusText)\n  this.uploadFiles(e.originalEvent.dataTransfer.files)\n}\n\nMultiFileUpload.prototype.uploadFiles = function (files) {\n  for (let i = 0; i < files.length; i++) {\n    this.uploadFile(files[i])\n  }\n}\n\nMultiFileUpload.prototype.onFileChange = function (e) {\n  this.feedbackContainer.removeClass('moj-hidden')\n  this.status.html(this.params.uploadStatusText)\n  this.uploadFiles(e.currentTarget.files)\n  this.fileInput.replaceWith($(e.currentTarget).val('').clone(true))\n  this.setupFileInput()\n  this.fileInput.get(0).focus()\n}\n\nMultiFileUpload.prototype.onFileFocus = function (e) {\n  this.label.addClass('moj-multi-file-upload--focused')\n}\n\nMultiFileUpload.prototype.onFileBlur = function (e) {\n  this.label.removeClass('moj-multi-file-upload--focused')\n}\n\nMultiFileUpload.prototype.getSuccessHtml = function (success) {\n  return `<span class=\"moj-multi-file-upload__success\"> <svg class=\"moj-banner__icon\" fill=\"currentColor\" role=\"presentation\" focusable=\"false\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 25 25\" height=\"25\" width=\"25\"><path d=\"M25,6.2L8.7,23.2L0,14.1l4-4.2l4.7,4.9L21,2L25,6.2z\"/></svg>${success.messageHtml}</span>`\n}\n\nMultiFileUpload.prototype.getErrorHtml = function (error) {\n  return `<span class=\"moj-multi-file-upload__error\"> <svg class=\"moj-banner__icon\" fill=\"currentColor\" role=\"presentation\" focusable=\"false\" xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 25 25\" height=\"25\" width=\"25\"><path d=\"M13.6,15.4h-2.3v-4.5h2.3V15.4z M13.6,19.8h-2.3v-2.2h2.3V19.8z M0,23.2h25L12.5,2L0,23.2z\"/></svg>${error.message}</span>`\n}\n\nMultiFileUpload.prototype.getFileRowHtml = function (file) {\n  const html = `\n    <div class=\"govuk-summary-list__row moj-multi-file-upload__row\">\n      <div class=\"govuk-summary-list__value moj-multi-file-upload__message\">\n        <span class=\"moj-multi-file-upload__filename\">${file.name}</span>\n        <span class=\"moj-multi-file-upload__progress\">0%</span>\n      </div>\n      <div class=\"govuk-summary-list__actions moj-multi-file-upload__actions\"></div>\n    </div>`\n  return html\n}\n\nMultiFileUpload.prototype.getDeleteButtonHtml = function (file) {\n  return `<button class=\"moj-multi-file-upload__delete govuk-button govuk-button--secondary govuk-!-margin-bottom-0\" type=\"button\" name=\"delete\" value=\"${file.filename}\">\n      Delete <span class=\"govuk-visually-hidden\">${file.originalname}</span>\n    </button>`\n}\n\nMultiFileUpload.prototype.uploadFile = function (file) {\n  this.params.uploadFileEntryHook(this, file)\n  const item = $(this.getFileRowHtml(file))\n  const formData = new FormData()\n  formData.append('documents', file)\n  this.feedbackContainer.find('.moj-multi-file-upload__list').append(item)\n\n  $.ajax({\n    url: this.params.uploadUrl,\n    type: 'post',\n    data: formData,\n    processData: false,\n    contentType: false,\n    success: $.proxy(function (response) {\n      if (response.error) {\n        item\n          .find('.moj-multi-file-upload__message')\n          .html(this.getErrorHtml(response.error))\n        this.status.html(response.error.message)\n      } else {\n        item\n          .find('.moj-multi-file-upload__message')\n          .html(this.getSuccessHtml(response.success))\n        this.status.html(response.success.messageText)\n      }\n      item\n        .find('.moj-multi-file-upload__actions')\n        .append(this.getDeleteButtonHtml(response.file))\n      this.params.uploadFileExitHook(this, file, response)\n    }, this),\n    error: $.proxy(function (jqXHR, textStatus, errorThrown) {\n      this.params.uploadFileErrorHook(\n        this,\n        file,\n        jqXHR,\n        textStatus,\n        errorThrown\n      )\n    }, this),\n    xhr: function () {\n      const xhr = new XMLHttpRequest()\n      xhr.upload.addEventListener(\n        'progress',\n        function (e) {\n          if (e.lengthComputable) {\n            let percentComplete = e.loaded / e.total\n            percentComplete = parseInt(percentComplete * 100, 10)\n            item\n              .find('.moj-multi-file-upload__progress')\n              .text(` ${percentComplete}%`)\n          }\n        },\n        false\n      )\n      return xhr\n    }\n  })\n}\n\nMultiFileUpload.prototype.onFileDeleteClick = function (e) {\n  e.preventDefault() // if user refreshes page and then deletes\n  const button = $(e.currentTarget)\n  const data = {}\n  data[button[0].name] = button[0].value\n  $.ajax({\n    url: this.params.deleteUrl,\n    type: 'post',\n    dataType: 'json',\n    data,\n    success: $.proxy(function (response) {\n      if (response.error) {\n        // handle error\n      } else {\n        button.parents('.moj-multi-file-upload__row').remove()\n        if (\n          this.feedbackContainer.find('.moj-multi-file-upload__row').length ===\n          0\n        ) {\n          this.feedbackContainer.addClass('moj-hidden')\n        }\n      }\n      this.params.fileDeleteHook(this, response)\n    }, this)\n  })\n}\n"],"names":[],"mappings":"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"}